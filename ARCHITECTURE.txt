╔══════════════════════════════════════════════════════════════════════════════╗
║                    FERTILITY SUPPORT AGENT ARCHITECTURE                      ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   curl/CLI   │  │  Dashboard   │  │  Mobile App  │  │   Web App    │   │
│  │              │  │   (HTML/JS)  │  │   (Future)   │  │   (Future)   │   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
│         │                 │                  │                  │            │
│         └─────────────────┴──────────────────┴──────────────────┘            │
│                                     │                                        │
└─────────────────────────────────────┼────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API GATEWAY LAYER                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                         FastAPI Server                              │    │
│  │                                                                      │    │
│  │  POST /score      │  Score emotional distress                       │    │
│  │  GET  /health     │  Health check                                   │    │
│  │  GET  /metrics    │  Prometheus metrics                             │    │
│  │  GET  /docs       │  API documentation                              │    │
│  │                                                                      │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │    │
│  │  │ Rate Limiter │  │  Validation  │  │   Security   │             │    │
│  │  │  (60/min)    │  │  (2000 char) │  │  (Injection) │             │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘             │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                     │                                        │
└─────────────────────────────────────┼────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            AGENT ORCHESTRATION                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                      LangGraph Agent Workflow                       │    │
│  │                                                                      │    │
│  │    ┌──────────────────┐                                             │    │
│  │    │  START: Message  │                                             │    │
│  │    └────────┬─────────┘                                             │    │
│  │             │                                                        │    │
│  │             ▼                                                        │    │
│  │    ┌──────────────────┐                                             │    │
│  │    │ Domain Validator │  ◄── Prompt: Is this fertility-related?    │    │
│  │    │                  │                                             │    │
│  │    │ • Check domain   │      Examples: IVF, pregnancy, emotions    │    │
│  │    │ • Return bool    │                                             │    │
│  │    └────────┬─────────┘                                             │    │
│  │             │                                                        │    │
│  │             ├─── No ──► Score = -1 (Out of Domain) ──► END          │    │
│  │             │                                                        │    │
│  │             └─── Yes                                                │    │
│  │                  │                                                   │    │
│  │                  ▼                                                   │    │
│  │    ┌──────────────────┐                                             │    │
│  │    │ Emotional Scorer │  ◄── Prompt: Score distress 1-10           │    │
│  │    │                  │                                             │    │
│  │    │ • Analyze text   │      Examples: Crisis, high, moderate      │    │
│  │    │ • Score 1-10     │                                             │    │
│  │    │ • Confidence     │      Key indicators: hopelessness, etc.    │    │
│  │    │ • Key indicators │                                             │    │
│  │    └────────┬─────────┘                                             │    │
│  │             │                                                        │    │
│  │             ▼                                                        │    │
│  │    ┌──────────────────┐                                             │    │
│  │    │  Action Router   │  ◄── Rules: Score → Action mapping         │    │
│  │    │                  │                                             │    │
│  │    │ • Score 10       │      → emergency_alert                     │    │
│  │    │ • Score 8-9      │      → book_gp_appointment                 │    │
│  │    │ • Score 6-7      │      → notify_caretaker                    │    │
│  │    │ • Score 1-5      │      → log_only                            │    │
│  │    └────────┬─────────┘                                             │    │
│  │             │                                                        │    │
│  │             ▼                                                        │    │
│  │    ┌──────────────────┐                                             │    │
│  │    │   END: Response  │                                             │    │
│  │    │                  │                                             │    │
│  │    │ • Score          │                                             │    │
│  │    │ • Confidence     │                                             │    │
│  │    │ • Reasoning      │                                             │    │
│  │    │ • Action         │                                             │    │
│  │    │ • Metrics        │                                             │    │
│  │    └──────────────────┘                                             │    │
│  │                                                                      │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                     │                                        │
└─────────────────────────────────────┼────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              LLM PROVIDER                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                    HolisticAI Bedrock Proxy                         │    │
│  │                                                                      │    │
│  │  ┌──────────────────────────────────────────────────────────┐      │    │
│  │  │         AWS Bedrock - Claude 3.5 Sonnet                   │      │    │
│  │  │                                                            │      │    │
│  │  │  • Model: us.anthropic.claude-3-5-sonnet-20241022-v2:0   │      │    │
│  │  │  • Temperature: 0.7                                       │      │    │
│  │  │  • Max Tokens: 1024                                       │      │    │
│  │  │  • Timeout: 30s                                           │      │    │
│  │  └──────────────────────────────────────────────────────────┘      │    │
│  │                                                                      │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          OBSERVABILITY LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐         │
│  │   LangSmith      │  │ Structured Logs  │  │ Prometheus       │         │
│  │   Tracing        │  │ (JSON)           │  │ Metrics          │         │
│  │                  │  │                  │  │                  │         │
│  │ • Every LLM call │  │ • Correlation ID │  │ • Requests       │         │
│  │ • Agent steps    │  │ • Events         │  │ • Latency        │         │
│  │ • Token usage    │  │ • Security       │  │ • Tokens         │         │
│  │ • Latency        │  │ • Errors         │  │ • Cost           │         │
│  │ • Errors         │  │ • Metrics        │  │ • Errors         │         │
│  │                  │  │                  │  │ • Injections     │         │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘         │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            SECURITY LAYER                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐         │
│  │ Injection        │  │ Input            │  │ Rate             │         │
│  │ Detection        │  │ Validation       │  │ Limiting         │         │
│  │                  │  │                  │  │                  │         │
│  │ • 18+ patterns   │  │ • Max length     │  │ • 60 req/min     │         │
│  │ • Regex matching │  │ • Sanitization   │  │ • Per IP         │         │
│  │ • Security logs  │  │ • Repetition     │  │ • Configurable   │         │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘         │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                              DATA FLOW                                       ║
╚══════════════════════════════════════════════════════════════════════════════╝

1. Client sends message → FastAPI
2. FastAPI validates input → Security checks
3. Agent validates domain → Bedrock LLM
4. If in-domain → Agent scores emotion → Bedrock LLM
5. Agent routes action → Rule-based logic
6. Response returned → Client
7. Metrics logged → Prometheus
8. Traces sent → LangSmith
9. Events logged → Structured logs

╔══════════════════════════════════════════════════════════════════════════════╗
║                           PERFORMANCE METRICS                                ║
╚══════════════════════════════════════════════════════════════════════════════╝

Latency:
  p50: ~1.2s  ████████████░░░░░░░░
  p95: ~2.5s  █████████████████████████░░░░░
  p99: ~4.0s  ████████████████████████████████████████

Tokens:
  Average: ~400 tokens per request
  Cost: ~$0.003 per request

Accuracy:
  ±1 score: 85%+  █████████████████░░░
  ±2 score: 95%+  ███████████████████░

Security:
  Injection Detection: 90%+  ██████████████████░░

╔══════════════════════════════════════════════════════════════════════════════╗
║                            DEPLOYMENT VIEW                                   ║
╚══════════════════════════════════════════════════════════════════════════════╝

Development:
  uvicorn main:app --reload
  └─► http://localhost:8000

Production (Future):
  Docker Container
  └─► Kubernetes Pod
      ├─► Load Balancer
      ├─► Auto-scaling (2-10 replicas)
      ├─► Redis Cache
      ├─► PostgreSQL Database
      └─► Monitoring Stack
          ├─► Prometheus
          ├─► Grafana
          └─► LangSmith

╔══════════════════════════════════════════════════════════════════════════════╗
║                          TECHNOLOGY STACK                                    ║
╚══════════════════════════════════════════════════════════════════════════════╝

Backend:
  • Python 3.11+
  • FastAPI (async web framework)
  • Pydantic (data validation)
  • uvicorn (ASGI server)

AI/ML:
  • LangChain (LLM orchestration)
  • LangGraph (agent workflows)
  • AWS Bedrock (Claude 3.5 Sonnet)
  • HolisticAI Proxy (Bedrock access)

Observability:
  • LangSmith (tracing)
  • Prometheus (metrics)
  • Structured logging (JSON)

Security:
  • slowapi (rate limiting)
  • Custom injection detection
  • Input validation

Testing:
  • pytest (test framework)
  • pytest-asyncio (async tests)
  • Rich (terminal output)

Package Management:
  • uv (fast Python package manager)

╔══════════════════════════════════════════════════════════════════════════════╗
║                              END                                             ║
╚══════════════════════════════════════════════════════════════════════════════╝
